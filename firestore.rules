/**
 * This ruleset enforces a security model with three distinct access levels for the Uttarakhand Getaways application.
 *
 * Core Philosophy:
 * 1.  User-Private Data: All data specific to a user, such as their profile and bookings, is strictly private.
 *     Access is granted only to the authenticated owner of that data.
 * 2.  Publicly Readable Data: Core business data, such as hotel and room listings, is public and can be read by
 *     any client, authenticated or not, to facilitate browsing.
 * 3.  Admin-Only Write Access: All modifications to public data (hotels, rooms) and management of administrative
 *     roles are restricted to users designated as administrators.
 *
 * Data Structure:
 * - User-specific data is nested under `/users/{userId}`, ensuring a clear and secure ownership boundary. For example,
 *   a user's bookings are stored at `/users/{userId}/bookings/{bookingId}`.
 * - Publicly accessible data, like hotels and their rooms, is stored in top-level collections (`/hotels`, `/hotels/{hotelId}/rooms`).
 * - Administrator status is managed via a dedicated lookup collection, `/roles_admin/{uid}`, where the existence of a
 *   document signifies that the user is an admin.
 *
 * Key Security Decisions:
 * - Admin roles are determined by document existence in `/roles_admin/{uid}` rather than a field on a user document.
 *   This avoids costly `get()` calls in rules and provides a fast, scalable way to check for administrative privileges.
 * - Listing all users is explicitly disallowed (`allow list: if false;` on `/users`) to protect user privacy.
 * - The ruleset follows a "default deny" posture. Access is only granted if an `allow` rule explicitly permits it.
 *
 * Denormalization for Authorization:
 * - Path-Based Ownership: The path `/users/{userId}` is the primary mechanism for authorizing access to user data.
 *   The rules simply check if the requesting user's UID matches the `userId` in the path.
 * - Role Lookup Collection: The `/roles_admin` collection is a form of denormalization. Instead of querying a user's
 *   profile to find their role, we perform a simple and efficient `exists()` check against this dedicated collection.
 *
 * Structural Segregation:
 * - User-private data (`/users/{userId}/bookings`) is structurally separate from public data (`/hotels`). This makes
 *   rules for listing documents simple and secure. A user can safely list their own bookings, and anyone can list
*   public hotels, without any risk of data leakage.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //-------------------------------------------------------------------------
    // Helper Functions
    //-------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the given userId.
     * This is the primary function for enforcing data ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the user is the owner AND the document already exists.
     * Used for safe update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Checks if the authenticated user has administrative privileges.
     * This is determined by the existence of their UID in the /roles_admin collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    //-------------------------------------------------------------------------
    // User Data Rules
    //-------------------------------------------------------------------------

    /**
     * @description Controls access to a user's own profile document.
     * @path /users/{userId}
     * @allow A signed-in user (create)s their own user document for the first time.
     * @deny An anonymous user tries to read a user's profile.
     * @principle A user can create and manage their own profile, but cannot view or delete other users' profiles.
     */
    match /users/{userId} {
      allow get, update: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow list, delete: if false;
    }

    /**
     * @description Secures a user's private collection of bookings.
     * @path /users/{userId}/bookings/{bookingId}
     * @allow A user (create)s a new booking for themselves, with a matching `userId` field in the data.
     * @deny A user tries to (list) the bookings of another user.
     * @principle Enforces strict data ownership within a user's private data tree. Validates relational integrity on create.
     */
    match /users/{userId}/bookings/{bookingId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    //-------------------------------------------------------------------------
    // Public Data Rules (Admin-Managed)
    //-------------------------------------------------------------------------

    /**
     * @description Defines access for the public hotel listings.
     * @path /hotels/{hotelId}
     * @allow Any user, including anonymous ones, can (get) or (list) all hotel documents.
     * @deny A regular, non-admin user attempts to (create) a new hotel listing.
     * @principle Data is public for reads, but all write operations are restricted to administrators.
     */
    match /hotels/{hotelId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin() && resource != null;
    }

    /**
     * @description Defines access for the public room listings nested under each hotel.
     * @path /hotels/{hotelId}/rooms/{roomId}
     * @allow Any user, including anonymous ones, can (get) or (list) all rooms for a given hotel.
     * @deny A regular, non-admin user attempts to (update) the price of a room.
     * @principle Data is public for reads, but all write operations are restricted to administrators.
     */
    match /hotels/{hotelId}/rooms/{roomId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update, delete: if isAdmin() && resource != null;
    }

    //-------------------------------------------------------------------------
    // Administrative Rules
    //-------------------------------------------------------------------------

    /**
     * @description Secures the collection that defines who is an administrator.
     * @path /roles_admin/{uid}
     * @allow An existing admin (create)s a document to grant another user admin rights.
     * @deny A non-admin user tries to (list) all the admins.
     * @principle Only existing administrators can view or modify the list of administrators.
     */
    match /roles_admin/{uid} {
      allow get, list, create, update, delete: if isAdmin();
    }
  }
}