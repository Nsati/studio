rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPERS ---

    // Check if the user is logged in
    function isAuthenticated() {
      return request.auth != null;
    }

    // Master Admin check using email (Bypasses all checks)
    function isMasterAdmin() {
      return isAuthenticated() && request.auth.token.email == 'mistrikumar42@gmail.com';
    }

    // General Admin check using a list of UIDs or DB role
    function isAdmin() {
      let adminUids = ['kk7Tsg8Ag3g1YMMR79rgrHUxq2W2']; // Add more Admin UIDs here
      return isMasterAdmin() || (isAuthenticated() && (request.auth.uid in adminUids || 
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')));
    }

    // Check if the authenticated user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- COLLECTION GROUP RULES ---
    // Critical for collectionGroup('bookings') queries. 
    // This allows searching across all user-nested booking subcollections.
    match /{path=**}/bookings/{bookingId} {
      
      // 1. Admins can read all bookings. 
      // 2. Logged-in users can only list/read bookings where the 'userId' field matches their UID.
      allow read, list: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      // 3. Authenticated users can create a booking if they set themselves as the owner.
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // 4. Only Admins or the Owner can update or delete a booking.
      allow update, delete: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
    }

    // --- STANDARD COLLECTION RULES ---

    // User Profiles
    match /users/{userId} {
      allow read, write: if isAdmin() || isOwner(userId);
      allow list: if isAdmin();
      
      // Recursive rule for any other user subcollections
      match /{allSubcollections=**} {
        allow read, write: if isAdmin() || isOwner(userId);
      }
    }

    // Hotels & Rooms (Public read, Admin write)
    match /hotels/{hotelId} {
      allow read: if true;
      allow write: if isAdmin();

      match /rooms/{roomId} {
        allow read: if true;
        // Authenticated users can update availableRooms during a booking transaction
        allow update: if isAuthenticated() || isAdmin();
        allow write: if isAdmin();
      }
      
      match /reviews/{reviewId} {
        allow read: if true;
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      }
    }

    // Content Collections
    match /cities/{cityId} { allow read: if true; allow write: if isAdmin(); }
    match /tourPackages/{packageId} { allow read: if true; allow write: if isAdmin(); }
    match /promotions/{promoId} { allow read: if true; allow write: if isAdmin(); }
  }
}